<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>社宅狀況比例圖</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    #main {
      width: 100%;
      height: 450px;
      margin-top: 30px;
    }
  </style>
</head>
<body>

<div id="controls">
  <label><input type="checkbox" class="roomFilter" value="一房型" checked> 一房型</label>
  <label><input type="checkbox" class="roomFilter" value="二房型" checked> 二房型</label>
  <label><input type="checkbox" class="roomFilter" value="三房型" checked> 三房型</label>
</div>

<div id="main"></div>

<script>
  const rawData = {
      "中路一號": {
        "一房型": { "出租": 10, "空置": 2, "修繕": 1, "專案保留": 1 },
        "二房型": { "出租": 20, "空置": 3, "修繕": 2, "專案保留": 0 },
        "三房型": { "出租": 5,  "空置": 1, "修繕": 1, "專案保留": 1 }
      },
      "中路二號": {
        "一房型": { "出租": 10, "空置": 2, "修繕": 1, "專案保留": 1 },
        "二房型": { "出租": 20, "空置": 3, "修繕": 2, "專案保留": 0 },
        "三房型": { "出租": 5,  "空置": 1, "修繕": 1, "專案保留": 1 }  
      },
      "中路三號": {
        "一房型": { "出租": 10, "空置": 2, "修繕": 1, "專案保留": 1 },
        "二房型": { "出租": 20, "空置": 3, "修繕": 2, "專案保留": 0 },
        "三房型": { "出租": 5,  "空置": 1, "修繕": 1, "專案保留": 1 }
      },
      "中路四號": {
        "一房型": { "出租": 10, "空置": 2, "修繕": 1, "專案保留": 1 },
        "二房型": { "出租": 20, "空置": 3, "修繕": 2, "專案保留": 0 },
        "三房型": { "出租": 5,  "空置": 1, "修繕": 1, "專案保留": 1 }  
      },
      "蘆竹一號": {
        "一房型": { "出租": 10, "空置": 2, "修繕": 1, "專案保留": 1 },
        "二房型": { "出租": 20, "空置": 3, "修繕": 2, "專案保留": 0 },
        "三房型": { "出租": 5,  "空置": 1, "修繕": 1, "專案保留": 1 }  
      },
      "蘆竹二號": {
        "一房型": { "出租": 10, "空置": 2, "修繕": 1, "專案保留": 1 },
        "二房型": { "出租": 20, "空置": 3, "修繕": 2, "專案保留": 0 },
        "三房型": { "出租": 5,  "空置": 1, "修繕": 1, "專案保留": 1 }  
      },
      "八德一號": {
        "一房型": { "出租": 10, "空置": 2, "修繕": 1, "專案保留": 1 },
        "二房型": { "出租": 20, "空置": 3, "修繕": 2, "專案保留": 0 },
        "三房型": { "出租": 5,  "空置": 1, "修繕": 1, "專案保留": 1 }  
      },
      "八德二號": {
        "一房型": { "出租": 10, "空置": 2, "修繕": 1, "專案保留": 1 },
        "二房型": { "出租": 20, "空置": 3, "修繕": 2, "專案保留": 0 },
        "三房型": { "出租": 5,  "空置": 1, "修繕": 1, "專案保留": 1 }  
      },
      "中壢一號": {
        "一房型": { "出租": 10, "空置": 2, "修繕": 1, "專案保留": 1 },
        "二房型": { "出租": 20, "空置": 3, "修繕": 2, "專案保留": 0 },
        "三房型": { "出租": 5,  "空置": 1, "修繕": 1, "專案保留": 1 }  
      },
      "中壢二號": {
        "一房型": { "出租": 10, "空置": 2, "修繕": 1, "專案保留": 1 },
        "二房型": { "出租": 20, "空置": 3, "修繕": 2, "專案保留": 0 },
        "三房型": { "出租": 5,  "空置": 1, "修繕": 1, "專案保留": 1 }  
      },
      "平鎮一號": {
        "一房型": { "出租": 10, "空置": 2, "修繕": 1, "專案保留": 1 },
        "二房型": { "出租": 20, "空置": 3, "修繕": 2, "專案保留": 0 },
        "三房型": { "出租": 5,  "空置": 1, "修繕": 1, "專案保留": 1 }  
      },
      "楊梅一號": {
        "一房型": { "出租": 10, "空置": 2, "修繕": 1, "專案保留": 1 },
        "二房型": { "出租": 20, "空置": 3, "修繕": 2, "專案保留": 0 },
        "三房型": { "出租": 5,  "空置": 1, "修繕": 1, "專案保留": 1 }  
      },
      "東門段(都更)": {
        "一房型": { "出租": 10, "空置": 2, "修繕": 1, "專案保留": 1 },
        "二房型": { "出租": 20, "空置": 3, "修繕": 2, "專案保留": 0 },
        "三房型": { "出租": 5,  "空置": 1, "修繕": 1, "專案保留": 1 }  
      },
      "中興巷(都更)": {
        "一房型": { "出租": 10, "空置": 2, "修繕": 1, "專案保留": 1 },
        "二房型": { "出租": 20, "空置": 3, "修繕": 2, "專案保留": 0 },
        "三房型": { "出租": 5,  "空置": 1, "修繕": 1, "專案保留": 1 }  
      }
    };

  const usageTypes = ['出租', '空置', '修繕', '專案保留'];
  const roomTypes = ['一房型', '二房型', '三房型'];
  const colors = {
    '出租': '#4caf50',
    '空置': '#ff9800',
    '修繕': '#f44336',
    '專案保留': '#9e9e9e'
  };

  const chart = echarts.init(document.getElementById('main'));

  function renderChart() {
    const selectedRooms = Array.from(document.querySelectorAll('.roomFilter:checked')).map(e => e.value);

    const categories = Object.keys(rawData);
    const series = usageTypes.map(type => {
      return {
        name: type,
        type: 'bar',
        stack: 'total',
        barWidth: '60%',
        label: {
          show: true,
          position: 'inside',
          formatter: (params) => {
            const val = params.value * 100;
            return val === 0 ? '' : `${Math.round(val)}%`;
          }
        },
        itemStyle: { color: colors[type] },
        data: categories.map(house => {
          const roomData = rawData[house];
          let numerator = 0;
          let denominator = 0;
          selectedRooms.forEach(rt => {
            const val = roomData[rt];
            if (val) {
              numerator += val[type] || 0;
              usageTypes.forEach(t => denominator += val[t] || 0);
            }
          });
          return denominator > 0 ? numerator / denominator : 0;
        })
      }
    });

    const option = {
      tooltip: {
        trigger: 'axis',
        axisPointer: { type: 'shadow' },
        formatter: function (params) {
          const name = params[0].axisValue;
          let str = `<b>${name}</b><br/>`;
          params.forEach(p => {
            str += `${p.marker}${p.seriesName}: ${(p.value * 100).toFixed(1)}%<br/>`;
          });
          return str;
        }
      },
      legend: { top: 10 },
      grid: { left: 80, right: 50, top: 60, bottom: 50 },
      xAxis: { type: 'category', data: categories },
      yAxis: {
        type: 'value',
        max: 1,
        axisLabel: { formatter: val => `${val * 100}%` }
      },
      series
    };

    chart.setOption(option);
  }

  renderChart();

  document.querySelectorAll('.roomFilter').forEach(cb => cb.addEventListener('change', renderChart));

  //const chart = echarts.init(document.getElementById('main'));
  //chart.setOption(option);

  chart.on('click', function (params) {
    const name = params.name;
    window.parent.postMessage({ type: 'selectHousing', name }, '*');
    window.parent.postMessage({ type: 'goToBarNew' }, '*');
  });

</script>

</body>
</html>