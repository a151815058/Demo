<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ç¤¾å®…åœ–è¡¨</title>
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      text-align: center;
    }

    .tabs {
      display: flex;
      justify-content: center;
      margin-top: 10px;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background: #eee;
      border: 1px solid #ccc;
      border-bottom: none;
      margin: 0 2px;
    }

    .tab.active {
      background: #fff;
      font-weight: bold;
    }

    .tab-content {
      display: none;
      padding: 20px;
      border: 1px solid #ccc;
    }

    .tab-content.active {
      display: block;
    }

    #chartdiv {
      width: 100%;
      max-width: 650px;
      height: 400px;
      margin: 0 auto;
    }

    .info-wrapper {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-top: 10px;
      font-size: 16px;
      color: #444;
    }

    .info-wrapper > div {
      display: none;
    }

    .chart-box {
      width: 100%;
      height: 500px;
      margin-bottom: 20px;
    }

    .details-box {
      font-size: 14px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <!-- é ç±¤é¸å–® -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('tab1')">ä½æˆ¶åˆ†å¸ƒ</div>
    <div class="tab" onclick="switchTab('tab2')">ç¤¾å®…ä¿®ç¹•ç‹€æ³</div>
    <div class="tab" onclick="switchTab('tab3')">ç¤¾å®…æ‹›ç§Ÿæƒ…æ³</div>
  </div>

  <!-- ä½æˆ¶åˆ†å¸ƒ -->
  <div id="tab1" class="tab-content active">
    <div id="chartdiv"></div>
    <div class="info-wrapper">
      <div id="rentRate">å‡ºç§Ÿç‡ï¼š--%</div>
      <div id="aboriginalRate">åŸä½æ°‘æ¯”ä¾‹ï¼š--%</div>
    </div>
  </div>

  <!-- ç¤¾å®…ä¿®ç¹•ç‹€æ³ -->
  <div id="tab2" class="tab-content">
    <h3 id="repairTitle">ç¤¾å®…ä¿®ç¹•ç‹€æ³</h3>
    <div id="repairCombinedChart" class="chart-box"></div>
    <div id="repairDetailInfo" class="details-box"></div>
  </div>

  <!-- ç¤¾å®…æ‹›ç§Ÿæƒ…æ³ç‹€æ³ -->
  <div id="tab3" class="tab-content">
    <h3>ç¤¾å®…æ‹›ç§Ÿæƒ…æ³</h3>
    <p>è«‹æ–¼æ­¤å€é¡¯ç¤ºæ‹›ç§Ÿæƒ…æ³ï¼Œä¾‹å¦‚éš¨åˆ°éš¨è¾¦ã€çºŒç§Ÿã€é€€ç§Ÿç­‰ã€‚</p>
  </div>

  <script>
    function switchTab(tabId) {
      const tabs = document.querySelectorAll('.tab');
      const contents = document.querySelectorAll('.tab-content');
      tabs.forEach(t => t.classList.remove('active'));
      contents.forEach(c => c.classList.remove('active'));
      document.querySelector(`[onclick*="${tabId}"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');
    }

    const repairRawData = {
      "ä¸­è·¯ä¸€è™Ÿ": { repairs: { æ¼æ°´: 3, é›»åŠ›: 2, åœ°æ¿: 1 }, avgDays: { æ¼æ°´: 5, é›»åŠ›: 3, åœ°æ¿: 2 } },
      "å…«å¾·ä¸€è™Ÿ": { repairs: { æ¼æ°´: 2, é›»åŠ›: 3, åœ°æ¿: 0 }, avgDays: { æ¼æ°´: 6, é›»åŠ›: 4, åœ°æ¿: 2 } },
      "ä¸­å£¢ä¸€è™Ÿ": { repairs: { æ¼æ°´: 1, é›»åŠ›: 1, åœ°æ¿: 2 }, avgDays: { æ¼æ°´: 4, é›»åŠ›: 2, åœ°æ¿: 3 } }
    };

    function renderRepairChart(name) {
      am5.array.each(am5.registry.rootElements, function (root) {
        if (root.dom.id === "repairCombinedChart") {
          root.dispose();
        }
      });

      let root = am5.Root.new("repairCombinedChart");
      root.setThemes([am5themes_Animated.new(root)]);

      let chart = root.container.children.push(am5xy.XYChart.new(root, {
        layout: root.verticalLayout
      }));

      const data = repairRawData[name];
      if (!data) return;

      const lineData = Object.keys(data.repairs).map(type => ({
        category: type,
        count: data.repairs[type],
        days: data.avgDays[type]
      }));

      let xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
        categoryField: "category",
        renderer: am5xy.AxisRendererX.new(root, {})
      }));
      xAxis.data.setAll(lineData);

      let yAxisLeft = chart.yAxes.push(am5xy.ValueAxis.new(root, {
        renderer: am5xy.AxisRendererY.new(root, {})
      }));

      let yAxisRight = chart.yAxes.push(am5xy.ValueAxis.new(root, {
        renderer: am5xy.AxisRendererY.new(root, { opposite: true })
      }));

      let lineSeries = chart.series.push(am5xy.LineSeries.new(root, {
        name: "ä¿®ç¹•æ¬¡æ•¸",
        xAxis: xAxis,
        yAxis: yAxisLeft,
        valueYField: "count",
        categoryXField: "category",
        tooltip: am5.Tooltip.new(root, { labelText: "{categoryX}\næ¬¡æ•¸: {valueY} æ¬¡" })
      }));
      lineSeries.data.setAll(lineData);

      let barSeries = chart.series.push(am5xy.ColumnSeries.new(root, {
        name: "å¹³å‡è€—æ™‚(å¤©)",
        xAxis: xAxis,
        yAxis: yAxisRight,
        valueYField: "days",
        categoryXField: "category",
        tooltip: am5.Tooltip.new(root, { labelText: "{categoryX}\nè€—æ™‚: {valueY} å¤©" })
      }));
      barSeries.data.setAll(lineData);

      const detailBox = document.getElementById("repairDetailInfo");

      [lineSeries, barSeries].forEach(series => {
        series.columns && series.columns.template.events.on("click", function (ev) {
          const category = ev.target.dataItem.dataContext.category;
          const detail = `ğŸ”§ é¡å‹ï¼š${category}ï½œæ¬¡æ•¸ï¼š${data.repairs[category]} æ¬¡ï½œå¹³å‡è€—æ™‚ï¼š${data.avgDays[category]} å¤©`;
          detailBox.textContent = detail;
        });
        series.strokes && series.strokes.template.events.on("click", function (ev) {
          const category = ev.target.dataItem.dataContext.category;
          const detail = `ğŸ”§ é¡å‹ï¼š${category}ï½œæ¬¡æ•¸ï¼š${data.repairs[category]} æ¬¡ï½œå¹³å‡è€—æ™‚ï¼š${data.avgDays[category]} å¤©`;
          detailBox.textContent = detail;
        });
      });
    }
  </script>

  <script>
    let root = am5.Root.new("chartdiv");
    root.setThemes([am5themes_Animated.new(root)]);

    let chart = root.container.children.push(
      am5percent.PieChart.new(root, {
        endAngle: 270,
        layout: root.verticalLayout,
        paddingRight: 80,
        paddingLeft: 80
      })
    );

    let series = chart.series.push(
      am5percent.PieSeries.new(root, {
        valueField: "value",
        categoryField: "category",
        endAngle: 270
      })
    );

    series.data.setAll([{ category: "è«‹é»é¸ç¤¾å®…", value: 1 }]);

    const titleLabel = am5.Label.new(root, {
      text: "è«‹é»é¸ç¤¾å®…åç¨±",
      fontSize: 20,
      centerX: am5.percent(50),
      x: am5.percent(50),
      marginBottom: 15
    });
    chart.children.unshift(titleLabel);

    window.addEventListener("message", (event) => {
      const { name, values } = event.data;
      titleLabel.set("text", name + " ä½æˆ¶åˆ†å¸ƒ");

      const rentRateElement = document.getElementById("rentRate");
      const aboriginalRateElement = document.getElementById("aboriginalRate");
      rentRateElement.style.display = "none";
      aboriginalRateElement.style.display = "none";

      const total = values.reduce((sum, item) => sum + item.value, 0);
      const rentedValue = values.filter(item => item.category === "æ”¿ç­–æˆ¶" || item.category === "ä¸€èˆ¬æˆ¶")
                                 .reduce((sum, item) => sum + item.value, 0);

      if (total > 0 && rentedValue > 0) {
        const rate = ((rentedValue / total) * 100).toFixed(1);
        rentRateElement.textContent = `å‡ºç§Ÿç‡ï¼š${rate}%`;
        rentRateElement.style.display = "block";
      }

      const policyItem = values.find(item => item.category === "æ”¿ç­–æˆ¶");
      if (policyItem) {
        const aboriginalCount = Math.round(policyItem.value * 0.2);
        const rate = ((aboriginalCount / policyItem.value) * 100).toFixed(1);
        aboriginalRateElement.textContent = `åŸä½æ°‘æ¯”ä¾‹ï¼š${rate}%`;
        aboriginalRateElement.style.display = "block";
      }

      series.data.setAll(values);

      renderRepairChart(name);
      document.getElementById("repairTitle").innerText = name + " ä¿®ç¹•ç‹€æ³";
    });
  </script>
</body>
</html>
