
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>店鋪招租狀況</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    .content-wrapper { display: flex; gap: 20px; margin-top: 30px; }
    .info-section { flex: 2; min-width: 600px; }
    .details { overflow-x: auto; width: 100%; }
    #chartContainer { flex: 2; display: flex; flex-direction: column; align-items: center; height: 100%; }
    #chartdiv, #pieChart { width: 100%; height: 100%; min-height: 300px; }
    .section { margin-top: 20px; }
    .section h3 { border-bottom: 1px solid #ccc; padding-bottom: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .chart-header { font-size: 16px; font-weight: bold; margin-bottom: 10px; text-align: center; }
    .tab-header { display: flex; border-bottom: 2px solid #ccc; margin-bottom: 10px; width: 100%; }
    .tab-button {
      padding: 10px 20px; cursor: pointer; background-color: #f9f9f9;
      border: none; border-bottom: 2px solid transparent; font-weight: bold;
    }
    .tab-button.active { border-bottom: 2px solid #3f51b5; background-color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
</head>
<body>

<h2 style="text-align:center">社宅店鋪招租狀況</h2>

<div class="content-wrapper">
  <div class="info-section">
    <div class="details" id="detailsContainer"></div>
  </div>

  <div id="chartContainer">
    <div class="tab-header">
      <button class="tab-button active" onclick="switchTab('chart')">店舖營運圖表</button>
      <button class="tab-button" onclick="switchTab('nature')">店鋪申請性質統計</button>
    </div>

    <div class="tab-content active" id="chartTab">
      <div class="chart-header" id="chartHeader"></div>
      <div id="chartdiv"></div>
    </div>

    <div class="tab-content" id="natureTab">
      <div class="chart-header" id="pieHeader">進駐店鋪申請性質統計</div>
      <div id="pieChart"></div>
    </div>
  </div>
</div>

<script>
  const stores = [
    { name: "中路一號", shop: "店1", status: "leasing", type: "專案" },
    { name: "中路一號", shop: "店2", status: "occupied", type: "公開", rentDue: 90000, rentPaid: 75000, nature: "商業" },
    { name: "中路一號", shop: "店3", status: "occupied", type: "專案", rentDue: 60000, rentPaid: 58000, nature: "商業" },
    { name: "八德一號", shop: "店1", status: "leasing", type: "公開" },
    { name: "八德一號", shop: "店2", status: "occupied", type: "公開", rentDue: 86000, rentPaid: 77000, nature: "服務" },
    { name: "平鎮一號", shop: "店1", status: "leasing", type: "專案" }
  ];

  function renderBarChart(data) {
    const chartData = data.map(s => {
      const due = s.rentDue || 0;
      const paid = s.rentPaid || 0;
      return {
        label: `${s.name}-${s.shop}`,
        已收: paid,
        未收: due - paid,
        應收總額: due
      };
    });

    const totalDue = chartData.reduce((sum, item) => sum + item.應收總額, 0);
    const totalPaid = chartData.reduce((sum, item) => sum + item.已收, 0);
    const totalUnpaid = chartData.reduce((sum, item) => sum + item.未收, 0);
    document.getElementById("chartHeader").innerText = `應收金額: ${totalDue}  / 已收金額: ${totalPaid}   / 未收金額: ${totalUnpaid}`;

    document.getElementById("chartdiv").innerHTML = "";
    am5.ready(function () {
      let root = am5.Root.new("chartdiv");
      root.setThemes([am5themes_Animated.new(root)]);
      let chart = root.container.children.push(am5xy.XYChart.new(root, { layout: root.verticalLayout }));
      let yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root, {
        categoryField: "label",
        renderer: am5xy.AxisRendererY.new(root, {})
      }));
      yAxis.data.setAll(chartData);
      let xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root, { renderer: am5xy.AxisRendererX.new(root, {}) }));

      ["已收", "未收"].forEach(field => {
        let series = chart.series.push(am5xy.ColumnSeries.new(root, {
          name: field, xAxis, yAxis,
          valueXField: field,
          categoryYField: "label",
          tooltip: am5.Tooltip.new(root, { labelText: "{categoryY}\n{name}: {valueX}" })
        }));
        series.data.setAll(chartData);
      });
      chart.appear(1000, 100);
    });
  }

  function renderPieChart(data) {
    const natureCount = {};
    data.forEach(s => {
      const key = s.nature || "其他";
      natureCount[key] = (natureCount[key] || 0) + 1;
    });

    const pieData = Object.entries(natureCount).map(([category, value]) => ({ category, value }));

    document.getElementById("pieChart").innerHTML = "";
    am5.ready(function () {
      let root = am5.Root.new("pieChart");
      root.setThemes([am5themes_Animated.new(root)]);
      let chart = root.container.children.push(am5percent.PieChart.new(root, {}));
      let series = chart.series.push(am5percent.PieSeries.new(root, {
        valueField: "value",
        categoryField: "category",
        tooltip: am5.Tooltip.new(root, { labelText: "{category}: {value}" })
      }));
      series.data.setAll(pieData);
      chart.appear(1000, 100);
    });
  }

  function renderBarChartByFilter(name, type) {
    const filtered = stores.filter(s => s.status === 'occupied' && s.name === name && s.type === type);
    switchTab('chart');
    renderBarChart(filtered);
    renderPieChart(filtered);
  }

  function switchTab(tabId) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelector(`.tab-button[onclick="switchTab('${tabId}')"]`).classList.add('active');
    document.getElementById(tabId + 'Tab').classList.add('active');
  }

  function showDetails() {
    const container = document.getElementById("detailsContainer");
    const grouped = {};
    stores.forEach(s => {
      if (!grouped[s.name]) grouped[s.name] = { shops: [] };
      grouped[s.name].shops.push(s);
    });

    let content = `
      <div class="section">
        <h3>店鋪狀況總覽</h3>
        <table>
          <thead>
            <tr>
              <th rowspan="2">社宅名稱</th>
              <th rowspan="2">總戶數</th>
              <th colspan="2">招租中</th>
              <th colspan="2">已進駐</th>
            </tr>
            <tr>
              <th>專案</th>
              <th>公開</th>
              <th>專案</th>
              <th>公開</th>
            </tr>
          </thead>
          <tbody>
            ${Object.entries(grouped).map(([name, data]) => {
              const leasingShops = data.shops.filter(s => s.status === 'leasing');
              const occupiedShops = data.shops.filter(s => s.status === 'occupied');
              const leasingProject = leasingShops.filter(s => s.type === '專案').length;
              const leasingPublic = leasingShops.filter(s => s.type === '公開').length;
              const occupiedProject = occupiedShops.filter(s => s.type === '專案').length;
              const occupiedPublic = occupiedShops.filter(s => s.type === '公開').length;
              const totalUnits = leasingProject + leasingPublic + occupiedProject + occupiedPublic + 2;
              return `
                <tr>
                  <td>${name}</td>
                  <td>${totalUnits}</td>
                  <td>${leasingProject}</td>
                  <td>${leasingPublic}</td>
                  <td><span style="color:blue;cursor:pointer" onclick="renderBarChartByFilter('${name}','專案')">${occupiedProject}</span></td>
                  <td><span style="color:blue;cursor:pointer" onclick="renderBarChartByFilter('${name}','公開')">${occupiedPublic}</span></td>
                </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;
    container.innerHTML = content;
  }

  showDetails();
</script>
</body>
</html>
